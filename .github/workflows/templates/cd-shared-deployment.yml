# Were we can define the inputs that our action will accept
inputs:
  service_name:
    required: true
  deploy:
    required: true
  subscriptionId:
    required: true
  tenantId:
    required: true
  deploymentOperatorId:
    required: true
  tags:
    required: true

runs:
  using: "composite"
  # Defining the action steps(Just one step to be simple)
  steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    # Login to Azure with Secret set in github
    - name: üîë Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_SPN_CREDENTIAL }}

    # Test Shared Infrastructure
    - name: üß™ Test Shared Infrastructure
      id: verify-what-if
      working-directory: "${{github.workspace}}/actions/bicep"
      run: |
        az deployment sub create --what-if -f ./Services/Common/infra.bicep --location westeurope 
        --parameters 
          serviceName=${{service_name}}
          subscriptionId=${{subscriptionId}}
          tenantId=${{tenantId}}
          deploymentOperatorId=${{deploymentOperatorId}}
          tags=${{tags}}

    # Deploy Shared Infrastructure
    - name: üèó Deploy Shared Infrastructure
      working-directory: "${{github.workspace}}/actions/bicep"
      run: |
        az deployment sub create -f ./Services/Common/infra.bicep --location westeurope
        --parameters 
          serviceName=${{service_name}}
          subscriptionId=${{subscriptionId}}
          tenantId=${{tenantId}}
          deploymentOperatorId=${{deploymentOperatorId}}
          tags=${{tags}}
