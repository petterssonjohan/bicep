# Note: additional setup is required, see https://www.jenkins.io/redirect/continuous-delivery-of-plugins

name: azure bicep deployment
on:
  workflow_call:
    inputs:
      service_name:
        description: 'Name of service, apc or ji for example.'
        required: true
        default: 'apc'
      deploy_prod:
        description: 'Deploy Shared Infrastructure'
        required: false
        default: 'false'
      deploy_shared: 'Deploy To Production'
        description: 'Deploy Infrastructure to Production'
        required: false
        default: 'false'
  check_run:
    types:
      - completed

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.verify-what-if.outputs.result == 'success' }}
    steps:
      - name: üîë Login to Azure
        uses: azure/login@v1
        id: login-to-azure
        with:
          creds: ${{ secrets.AZURE_SPN_CREDENTIAL }}

      - name: üß™ What if
        id: verify-what-if
        if: steps.login-to-azure.output.result == 'success'
        working-directory: "${{github.workspace}}/actions/bicep"
        run: |
          az deployment sub create --what-if -f ./Services/Common/infra.bicep --location westeurope --parameters @parameters.json

  release:
    runs-on: ubuntu-latest
    needs: [validate]
    if: needs.validate.should_release == 'true' && github.event.input.deploy_prod == 'true'
    steps:
      - name: üîë Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_SPN_CREDENTIAL }}

      - name: üîß Set Environment Variables
        uses: tw3lveparsecs/github-actions-setvars@v0.1
        with:
          envFilePath: "${{github.workspace}}/.env"

      - name: üèó Deploy infrastructure
        working-directory: "${{github.workspace}}/actions/bicep"
        run: |
          az deployment sub create -f ./Services/PassengerCount/Common.bicep --location westeurope --parameters @parameters.json

# This is a basic workflow to help you get started with Actions

# name: azure bicep deployment

# # Controls when the workflow will run
# on:
#   # Triggers the workflow on push or pull request events but only for the main branch
#   push:
#     branches: [main]
#   pull_request:
#     branches: [main]

#   # Allows you to run this workflow manually from the Actions tab
#   workflow_dispatch:

# stages:
#   - test
#   - prod

# test:
#   stage: test
#   # A workflow run is made up of one or more jobs that can run sequentially or in parallel
#   jobs:
#     # This workflow contains a single job called "build"
#     bicep_build:
#       name: bicep build
#       # The type of runner that the job will run on
#       runs-on: ubuntu-latest

#       # Steps represent a sequence of tasks that will be executed as part of the job
#       steps:
#         # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
#         - uses: actions/checkout@v2

#         - name: üîë Login to Azure
#           uses: azure/login@v1
#           with:
#             creds: ${{ secrets.AZURE_SPN_CREDENTIAL }}

#         - name: üîß Set Environment Variables
#           uses: tw3lveparsecs/github-actions-setvars@v0.1
#           with:
#             envFilePath: "${{github.workspace}}/.env"

#         - name: üß™ What if
#           working-directory: "${{github.workspace}}/actions/bicep"
#           run: |
#             az deployment sub create --what-if -f ./Services/Common/infra.bicep --location westeurope --parameters @parameters.json

#     bicep_deployment:
#       name: bicep deployment
#       # The type of runner that the job will run on
#       runs-on: ubuntu-latest
#       needs: [bicep_build]
#       environment: production

#       # Steps represent a sequence of tasks that will be executed as part of the job
#       steps:
#         # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
#         - uses: actions/checkout@v2

#         - name: üîë Login to Azure
#           uses: azure/login@v1
#           with:
#             creds: ${{ secrets.AZURE_SPN_CREDENTIAL }}

#         - name: üîß Set Environment Variables
#           uses: tw3lveparsecs/github-actions-setvars@v0.1
#           with:
#             envFilePath: "${{github.workspace}}/.env"

#         - name: üèó Deploy infrastructure
#           working-directory: "${{github.workspace}}/actions/bicep"
#           run: |
#             az deployment sub create -f ./Services/PassengerCount/Common.bicep --location westeurope --parameters @parameters.json
