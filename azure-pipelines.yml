trigger:
  - main

name: Deploy Bicep files

parameters:
  - name: DEPLOY_PROD
    displayName: Deploy to PROD
    type: boolean
    default: false

  - name: serviceName
    type: string
    default: apc
    values:
      - apc
      - ji

variables:
  vmImageName: "ubuntu-latest"
  resourceGroupName: "dps"
  location: "west europe"
  templateFile: "infra.bicep"
pool:
  vmImage: $(vmImageName)

stages:
  - stage: Test
    displayName: Build Test
    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: AzureCLI@2
            displayName: üß™ Test infrastructure (--what-if)
            inputs:
              azureSubscription: defaultAzureServiceConnection
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az --version
                az deployment sub create --what-if -f $(System.ArtifactsDirectory)/actions/bicep/Services/PassengerCount/main.bicep --location westeurope --parameters @parameters.${{parameters.serviceName}}.json
          - task: AzureCLI@2
            displayName: üèó Deploy infrastructure
            inputs:
              azureSubscription: defaultAzureServiceConnection
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az --version
                az deployment sub create -f $(System.ArtifactsDirectory)/actions/bicep/Services/PassengerCount/main.bicep --location westeurope --parameters @parameters.json
  - stage: Prod
    displayName: Deploy Prod
    condition: |
      and(
        succeeded('Build'), 
        eq(${{ parameters.DEPLOY_PROD }}, true)
      )
    jobs:
      - job: Build
        displayName: üß™ Test infrastructure
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: AzureCLI@2
            displayName: üß™ Test infrastructure (--what-if)
            inputs:
              azureSubscription: defaultAzureServiceConnection
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az --version
                az deployment sub create --what-if -f $(System.ArtifactsDirectory)/actions/bicep/Services/PassengerCount/main.bicep --location westeurope --parameters @parameters.json
      - job: Deploy
        displayName: üèó Deploy infrastructure
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: AzureCLI@2
            displayName: üèó Deploy infrastructure
            inputs:
              azureSubscription: defaultAzureServiceConnection
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az --version
                az deployment sub create -f $(System.ArtifactsDirectory)/actions/bicep/Services/PassengerCount/main.bicep --location westeurope --parameters @parameters.json
