trigger:
  - main

name: Deploy Bicep files

parameters:
  - name: DEPLOY_PROD
    displayName: Deploy to PROD
    type: boolean
    default: false

variables:
  vmImageName: "ubuntu-latest"
  resourceGroupName: "dps"
  location: "west europe"
  templateFile: "infra.bicep"
pool:
  vmImage: $(vmImageName)

stages:
  - stage: Build
    displayName: Building stage

    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: AzureCLI@2
            displayName: üß™ What if Bicep Deploy
            inputs:
              azureSubscription: defaultAzureServiceConnection
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az --version
                az deployment sub create --what-if -f $(System.ArtifactsDirectory)/actions/bicep/Services/PassengerCount/main.bicep --location westeurope --parameters @parameters.json
  - stage: Test
    displayName: Building stage
    condition: |
      and(
        succeeded('Build'), 
        eq(${{ parameters.DEPLOY_PROD }}, true)
      )
    jobs:
      - job: Build
        displayName: Test
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: AzureCLI@2
            displayName: üèó Deploy infrastructure
            inputs:
              azureSubscription: defaultAzureServiceConnection
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az --version
                az deployment sub create -f $(System.ArtifactsDirectory)/actions/bicep/Services/PassengerCount/main.bicep --location westeurope --parameters @parameters.json
