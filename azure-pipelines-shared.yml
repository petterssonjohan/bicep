parameters:
  - name: name # defaults for any parameters that aren't specified
    default: ""
  - name: vmImage
    default: ""
  - name: serviceName
    default: "spt"
  - name: deploy
    displayName: Deploy
    type: boolean
    default: false
  - name: vnetResourceGroup
    default: "dmsResourceGroup"
  - name: subscriptionId
    default: ""
  - name: tags
    type: object
    default:
      BUSINESS-AREA: "spt"
      RUNTIME-ENVIRONMENT: "test"

    stages:
      - stage: "Shared Infrastructure"
        jobs:
          job: "job"
          pool:
            vmImage: ${{vmImage}}
            steps:
              - task: AzureCLI@2
                displayName: üß™ Test Shared infrastructure
                inputs:
                  azureSubscription: defaultAzureServiceConnection
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az --version
                    az deployment sub create --what-if -f $(System.ArtifactsDirectory)/actions/bicep/Services/SharedResources/infra.bicep --location westeurope 
                    --parameters serviceName=misc subscriptionId=${{subscriptionId}} tags=${{tags}} vnetResourceGroup=dmsResourceGroup
              - task: AzureCLI@2
                displayName: üèó Deploy Shared infrastructure
                condition: |
                  and(
                    succeeded('Build'), 
                    eq(${{ parameters.deploy }}, true)
                  )
                inputs:
                  azureSubscription: defaultAzureServiceConnection
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az --version
                    az deployment sub create -f $(System.ArtifactsDirectory)/actions/bicep/Services/SharedResources/infra.bicep --location westeurope 
                    --parameters serviceName=misc subscriptionId=${{subscriptionId}} tags=${{tags}} vnetResourceGroup=dmsResourceGroup
